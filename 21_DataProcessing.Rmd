
```{r}
library(here)

source(here("00_requirements.R"))
```

First, we start the data set with the demographics data set.

```{r}
demographics = read_csv(
  here("Datasets", "demographics.csv"),
  # First two lines are unnecessary
  skip = 2,
  na = "N/A",
  
  # Data includes footnotes
  col_types = cols(
    Footnotes = col_skip() 
  )
)

print(demographics)
```

Then, we add the commuter data to the overall data set. For this, we must transform the data set in order to follow the overall format where our observations are each state and the columns are variables of each state.

```{r}
# --- Load and clean commuter data ---
commuter_data_raw <- read_tsv(here("Datasets", "state_commuter_mode.csv")) %>%
  
  rename(Share = "Commute mode share (percent)")  # Simplify column name

commuter_data_wide <- commuter_data_raw %>%
  
  filter(Year == 2023) %>%   # Keep only the most recent year
  select(-Year) %>%          # Drop the year column
  pivot_wider(               # Reshape from long to wide format
    names_from = Mode,
    values_from = Share
  )

print(commuter_data_wide)
```

Next, we read in the gun ownership data.

```{r}
gun_ownership_data <- read_csv(here("Datasets", "gun-ownership-by-state-2025.csv"))

# We will drop the first column, as it is not necessary.
gun_ownership_data <- gun_ownership_data[,-1]

# We will create a new name to increase clarity
names(gun_ownership_data)[2] <- "PercentageOfHouseholdsThatOwnGuns"
print(gun_ownership_data)
```


We will not aim to join the "covid_deaths" data set into our current overall data set.

```{r}
covid_deaths_raw <- read_csv(here("Datasets", "covid_deaths.csv"))

# We can extract the state names to make sure it follows the current structure
state_names <- unique(demographics$Location)

# Next, we will need to extract the rolling total from each state, as we are only interested in the total death count
latest_state_totals <- covid_deaths_raw %>%
  filter(Jurisdiction_Residence %in% state_names) %>%
  mutate(end_date = mdy(data_period_end)) %>%
  group_by(Jurisdiction_Residence) %>%
  arrange(desc(end_date)) %>%
  slice(1) %>%
  ungroup()

print(latest_state_totals)
```

Now, we will read the Unemployment_Income_Voting_Merged.csv data set and join it to complete our joined dataset.

```{r}
merged_data_raw <- read.csv(here("Datasets", "Unemployment_Income_Voting_Merged.csv"))
merged_data_raw$Median.Household.Income <- as.numeric(gsub(",", "", merged_data_raw$Median.Household.Income))
merged_data_clean <- merged_data_raw[-c(51, 53), -2]
merged_data_clean$State.Name[51] <- "District of Columbia"
print(merged_data_clean)
```

```{r}
joined_data <- demographics %>%
  left_join(commuter_data_wide, by = c("Location" = "State")) %>%
  left_join(gun_ownership_data, by = c("Location" = "state")) %>% 
  left_join(latest_state_totals, by = c("Location" = "Jurisdiction_Residence")) %>%
  left_join(merged_data_clean, by = c("Location" = "State.Name"))


joined_data <- joined_data[2:52, ]
print(head(joined_data))
glimpse(joined_data)
```


Here we will save the data set for future cleaning.

```{r save-data}
if (!dir.exists(here("processed_data"))) {
  dir.create(here("processed_data"))
}

save(joined_data, file = here("processed_data", "merged_data.RData"))
```



